name: Update Two OneDrive images to repo

on:
  workflow_dispatch:    # permite rodar manualmente
  schedule:
    - cron: '0 */2 * * *'  # roda a cada 2 horas (ajuste se quiser)

jobs:
  update-images:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node (for npx)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Convert OneDrive link 1 to direct URL (Ranking_Geral)
        id: convert1
        env:
          ONEDRIVE_SHARE_RANKING_GERAL: ${{ secrets.ONEDRIVE_SHARE_RANKING_GERAL }}
        run: |
          if [ -n "${ONEDRIVE_SHARE_RANKING_GERAL}" ]; then
            echo "Converting OneDrive link for Ranking_Geral..."
            DIRECT1=$(npx onedrive-link "$ONEDRIVE_SHARE_RANKING_GERAL" 2>/dev/null || true)
            if [ -z "$DIRECT1" ]; then
              DIRECT1="$ONEDRIVE_SHARE_RANKING_GERAL"
            fi
            echo "DIRECT1=$DIRECT1" >> $GITHUB_OUTPUT
          else
            echo "Missing secret ONEDRIVE_SHARE_RANKING_GERAL"
            exit 1
          fi

      - name: Convert OneDrive link 2 to direct URL (Ranking_Varejo)
        id: convert2
        env:
          ONEDRIVE_SHARE_RANKING_VAREJO: ${{ secrets.ONEDRIVE_SHARE_RANKING_VAREJO }}
        run: |
          if [ -n "${ONEDRIVE_SHARE_RANKING_VAREJO}" ]; then
            echo "Converting OneDrive link for Ranking_Varejo..."
            DIRECT2=$(npx onedrive-link "$ONEDRIVE_SHARE_RANKING_VAREJO" 2>/dev/null || true)
            if [ -z "$DIRECT2" ]; then
              DIRECT2="$ONEDRIVE_SHARE_RANKING_VAREJO"
            fi
            echo "DIRECT2=$DIRECT2" >> $GITHUB_OUTPUT
          else
            echo "Missing secret ONEDRIVE_SHARE_RANKING_VAREJO"
            exit 1
          fi

      - name: Download both images
        run: |
          mkdir -p images
          # URL para Ranking_Geral
          URL1="${{ steps.convert1.outputs.DIRECT1 }}"
          echo "Downloading Ranking_Geral from: $URL1"
          curl -L "$URL1" -o "images/Ranking_Geral.png" --fail
          # URL para Ranking_Varejo
          URL2="${{ steps.convert2.outputs.DIRECT2 }}"
          echo "Downloading Ranking_Varejo from: $URL2"
          curl -L "$URL2" -o "images/Ranking_Varejo.png" --fail
          echo "Files downloaded:"
          ls -lh images || true

      - name: Commit and push (auto-commit)
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Auto update images from OneDrive [skip ci]"
          file_pattern: "images/Ranking_Geral.png\nimages/Ranking_Varejo.png"
          branch: "main"
          create_branch: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
